namespace SpriteKind {
    export const Tail = SpriteKind.create()
}

enum Direction { Up, Right, Down, Left }

const NEXT_SECTION_KEY = "__child_node"
const background = img`
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    11111111bcffffcb11bcffffcb1111111111111111111111dcffffcb11dcffffcbd11111111111bcffffcb1111111111111111111111111111d322222b3111111111113e222243113e2222e311111111111111111111111111111111111111111111111111111111111111
    111111dcffffffffccffffffffcd111111bffffd1111111cffffffffccfffffffffd111111111cfffffffffb11111111111113222222311113e22222222b11111111de22222222ee222222222d111111111111111111111111111111111111111111111111111111111111
    111111cffffffffffffffffffffc111111bffffd111111cfffffffffffffffffffffd1111111cffffffffffcd11111111111322222231111b2222222222221111111e222222222222222222222111111111111111111111111111111111111111111111111111111111111
    11111bffffffffffffffffffffffb11111bffffd11111dffffffffffffffffffffffc111111bffffffffffffc1111111111d22222e31111d222222222222231111132222222222222222222222311111111111111111111111111111111111111111111111111111111111
    11111cfffffcbcffffffcbbfffffc11111bffffd11111bfffffcbcffffffcbbcfffffd11111fffffcbbcfffffd111111111e2222e311111b22222b3b22222e11111222222b3e22222223b22e22e11111111111111111111111111111111111111111111111111111111111
    11111fffffd111ffffff111dfffff11111bffffd11111cffffb111cfffffd111cffffd1111dffffc1111cffffb11111111b222223111111222223111d22222d1111222223111222222111d2222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffb1111bffffc1111111d22222b11111112222211111b2222311112222e11113222231111e222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111111e2222e11111111222241111132222311112222b111132222311114222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111111322222d11111111222241111132222311112222b11113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11111122222b1111111112222e1111132222311112222411113222231111b222e11111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111132222e1111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11111b222231111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111122222d1111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111132222b11111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111132222311111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111122222111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111122222111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111d22224111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111d22223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111322223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111322223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111322223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111322223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111d22223111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111d22224111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111122222111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11112222e111111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111b2222311111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffcbbbbcffffc111132222b11111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffffffffffffc111112222211111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffffffffffffc11111b222231111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffffffffffffc1111132222e1111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffccccccffffc111111222223111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11111132222e111111111222241111132222311112222411113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111111122222b11111111222e41111132e22311112222e11113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111111322222311111112222211111b2222311112222b11113222231111b222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11111111b222223111111222223111d22222d11112222411113222231111b22e211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111111111222222d11111b22222e34222222d11112222e111132222311114222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc111111111d22e222d1111d22e22222222223111112222411113222231111e222211111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc1111111111322222e31111322222222222211111122224111132222311114222e11111111111111111111111111111111111111111111111111111111111
    11111ffffc1111bffffb1111cffff11111bffffd11111cffff1111dffffc1111bffffb1111bffffd1111dffffc11111111111322222231111b2222222222d1111112222b111132222b1111be22e11111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111be2222b31111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
    `
const bodyPart = img`
    . . 5 5 5 5 . . 
    . 5 1 1 1 1 5 . 
    5 1 1 1 1 1 1 5 
    5 1 1 1 1 1 1 5 
    5 1 1 1 1 1 1 5 
    5 1 1 1 1 1 1 5 
    . 5 1 1 1 1 5 . 
    . . 5 5 5 5 . . 
    `
const pizzaImage = img`
    . . . . . . b b b b . . . . . . 
    . . . . . . b 4 4 4 b . . . . . 
    . . . . . . b b 4 4 4 b . . . . 
    . . . . . b 4 b b b 4 4 b . . . 
    . . . . b d 5 5 5 4 b 4 4 b . . 
    . . . . b 3 2 3 5 5 4 e 4 4 b . 
    . . . b d 2 2 2 5 7 5 4 e 4 4 e 
    . . . b 5 3 2 3 5 5 5 5 e e e e 
    . . b d 7 5 5 5 3 2 3 5 5 e e e 
    . . b 5 5 5 5 5 2 2 2 5 5 d e e 
    . b 3 2 3 5 7 5 3 2 3 5 d d e 4 
    . b 2 2 2 5 5 5 5 5 5 d d e 4 . 
    b d 3 2 d 5 5 5 d d d 4 4 . . . 
    b 5 5 5 5 d d 4 4 4 4 . . . . . 
    4 d d d 4 4 4 . . . . . . . . . 
    4 4 4 4 . . . . . . . . . . . . 
    `
const size = 8

let lastIteration = 0
let addSection = false
let timeout = 500
let pizza : Sprite

let addSectionTo: Sprite = null
let enqueued = false
let i = 0


scene.setBackgroundImage(background)
game.splash("para girar", "Usa ← →")
placePizza()
info.setScore(0)

let snake1 = createSnake(4, 12,  Direction.Up);

forever(function () {

    if (snake1.x < 0 ) {
        snake1.x = screen.width-4
    } 

    if (snake1.x > screen.width){
         snake1.x = 4
    }

    if (  snake1.y < 0 ){
        snake1.y = screen.height - 4
    }
    if(snake1.y > screen.height){
        snake1.y = 4
    }

    if (game.runtime() - lastIteration < timeout) {
        return;
    }

    if (addSection) {
        addSectionToBody()
    } else {
        move(snake1)
    }
    setHeadNextPosition(snake1)
    enqueued = false
    lastIteration = game.runtime()
})

function createSnake(x: number, y: number,  direction: Direction) : Sprite{
    let snake = sprites.create(bodyPart.clone(), SpriteKind.Player)
    
    snake.image.replace(0x1, 7)
    snake.left = x * size
    snake.top = y * size
    snake.data = {};
    snake.data.color = 7;
    snake.data.direction = direction;
return snake;
}

function addSectionToBody() {
    const newSection = sprites.create(bodyPart.clone(), SpriteKind.Tail)
    newSection.x = addSectionTo.x
    newSection.y = addSectionTo.y
   
    newSection.image.replace(0x1, addSectionTo.data.color);

    newSection.data = {};
    newSection.data[NEXT_SECTION_KEY] = addSectionTo.data[NEXT_SECTION_KEY]
    addSectionTo.data[NEXT_SECTION_KEY] = newSection
    addSection = false
}

function setHeadNextPosition(snake: Sprite) {
    switch (snake.data.direction) {
        case Direction.Up:
            snake.y -= size;
            break;
        case Direction.Down:
            snake.y += size;
            break;
        case Direction.Left:
            snake.x -= size;
            break;
        case Direction.Right:
            snake.x += size;
            break;
    }
}

function move(piece: Sprite) {
    const next = piece.data[NEXT_SECTION_KEY]
    if (next) {
        move(next)
        next.x = piece.x;
        next.y = piece.y;
    }
}


function setDirection(snake: Sprite, targetDir: Direction) {
    if (!enqueued) {
        snake.data.direction = targetDir;
        enqueued = true;
    }
}


function placePizza() {
    pizza = sprites.create(pizzaImage, SpriteKind.Food)
    do {
        pizza.left = randint(1, 18) * size;
        pizza.top = randint(1, 13) * size;
    } while (
        (pizza.top === 0 && pizza.right === screen.width)
        || sprites
            .allOfKind(SpriteKind.Tail)
            .some(s => s.overlapsWith(pizza))
    );
}

sprites.onOverlap(SpriteKind.Player, SpriteKind.Tail, function (sprite, otherSprite) {
    game.over(false)
})
sprites.onOverlap(SpriteKind.Player, SpriteKind.Food, function (player, food) {
    info.changeScoreBy(1)
    food.destroy(effects.disintegrate)
    music.magicWand.play()
    timeout = Math.max(150, timeout - 50)
    addSection = true
    addSectionTo = player
    placePizza()
})
controller.left.onEvent(ControllerButtonEvent.Pressed, function () {
    setDirection(snake1, (snake1.data.direction + 3) % 4);
})
controller.right.onEvent(ControllerButtonEvent.Pressed, function () {
    setDirection(snake1, Math.abs((snake1.data.direction + 1) % 4));
})

